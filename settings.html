<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ML Interview Prep Tracker - Settings</title>
  <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-content">
      <h1>ML Interview Prep Tracker</h1>
      <div class="header-right">
        <div id="syncIndicator" class="sync-indicator" onclick="supabaseSync.manualSync()">
          <span class="sync-icon">○</span>
          <span class="sync-text"></span>
        </div>
        <nav>
          <ul>
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="log.html">Daily Log</a></li>
            <li><a href="topics.html">Topics</a></li>
            <li><a href="applications.html">Applications</a></li>
            <li><a href="analytics.html">Analytics</a></li>
            <li><a href="settings.html" class="active">Settings</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <h2 class="page-title">Settings</h2>

    <!-- Cloud Sync -->
    <div class="card">
      <h2>Cloud Sync (Supabase)</h2>
      <div class="sync-status-card" id="syncStatusCard">
        <div class="sync-status-icon" id="syncStatusIcon">○</div>
        <div class="sync-status-details">
          <div class="sync-status-label" id="syncStatusLabel">Not Configured</div>
          <div class="sync-status-message" id="syncStatusMessage">Set up Supabase to sync across devices</div>
        </div>
      </div>

      <form id="syncForm" onsubmit="return saveSyncSettings(event)" style="margin-top: 16px;">
        <div class="form-group">
          <label for="supabaseUrl">Supabase Project URL</label>
          <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co">
          <small class="text-muted">Found in Project Settings > API</small>
        </div>

        <div class="form-group">
          <label for="supabaseKey">Supabase Anon Key</label>
          <div style="display: flex; gap: 8px;">
            <input type="password" id="supabaseKey" placeholder="eyJ..." style="flex: 1;">
            <button type="button" class="btn btn-small btn-secondary" onclick="toggleKeyVisibility()">Show</button>
          </div>
          <small class="text-muted">Found in Project Settings > API > anon public key</small>
        </div>

        <div class="form-group">
          <label for="supabaseUserId">User ID</label>
          <input type="text" id="supabaseUserId" placeholder="user_1234567890_abc123">
          <small class="text-muted">Unique identifier for your data row in Supabase. This ID links to your row in the user_data table.</small>
        </div>

        <div id="connectionTestResult" class="connection-result hidden"></div>

        <div class="btn-group" style="margin-top: 16px;">
          <button type="submit" class="btn">Save & Sync</button>
          <button type="button" class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
          <button type="button" class="btn btn-secondary" onclick="clearSyncSettings()">Disable Sync</button>
        </div>
      </form>

      <details style="margin-top: 24px;">
        <summary style="cursor: pointer; color: var(--primary); font-weight: 500;">Setup Instructions</summary>
        <div style="margin-top: 12px; padding: 16px; background: var(--gray-100); border-radius: 8px;">
          <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
            <li>Go to <a href="https://supabase.com" target="_blank">supabase.com</a> and create a free account</li>
            <li>Create a new project (free tier is sufficient)</li>
            <li>Go to <strong>Project Settings > API</strong></li>
            <li>Copy your <strong>Project URL</strong> and paste above</li>
            <li>Copy your <strong>anon public</strong> key and paste above</li>
            <li>Go to <strong>SQL Editor</strong> and run this query:
              <pre style="background: var(--gray-800); color: var(--white); padding: 12px; border-radius: 4px; margin: 8px 0; overflow-x: auto; font-size: 0.85rem;">CREATE TABLE IF NOT EXISTS user_data (
  user_id TEXT PRIMARY KEY,
  data JSONB NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);</pre>
            </li>
            <li>Click "Save & Sync" to enable sync! Use the "Sync Now" button in the header to sync manually.</li>
          </ol>
        </div>
      </details>
    </div>

    <!-- Goals Settings -->
    <div class="card">
      <h2>Goals</h2>
      <form id="goalsForm" onsubmit="return saveGoals(event)">
        <div class="form-group">
          <label for="weeklyGoalHours">Weekly Goal (hours)</label>
          <input type="number" id="weeklyGoalHours" name="weeklyGoalHours" min="1" max="100" value="14">
        </div>

        <div class="form-group">
          <label for="dailyGoalMinutes">Daily Goal (minutes)</label>
          <input type="number" id="dailyGoalMinutes" name="dailyGoalMinutes" min="5" max="480" value="30">
        </div>

        <button type="submit" class="btn">Save Goals</button>
      </form>
    </div>

    <!-- Data Management -->
    <div class="card">
      <h2>Data Management</h2>

      <div class="data-actions">
        <div class="data-action-item">
          <h3>Export Data</h3>
          <p class="text-muted">Download all your data as a JSON file.</p>
          <button class="btn btn-secondary" onclick="exportData()">Export</button>
        </div>

        <div class="data-action-item">
          <h3>Import Data</h3>
          <p class="text-muted">Import data from a JSON file.</p>
          <input type="file" id="importFile" accept=".json" style="display: none" onchange="importData(event)">
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import</button>
        </div>

        <div class="data-action-item danger">
          <h3>Clear All Data</h3>
          <p class="text-muted">Delete all local data. This cannot be undone.</p>
          <button class="btn btn-danger" onclick="clearAllData()">Clear Data</button>
        </div>
      </div>
    </div>

    <!-- Account -->
    <div class="card">
      <h2>Account</h2>
      <button class="btn btn-secondary" onclick="auth.logout()">Sign Out</button>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>ML Interview Prep Tracker v1.0</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./js/app.js"></script>
  <script src="./js/sync.js"></script>
  <script src="./js/auth.js"></script>
  <script>
    // Check authentication (async - syncs first to check device authorization)
    (async () => {
      const isAuthed = await auth.initWithSync();
      if (!isAuthed) return;
    })();

    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
      await data.init();
      loadSettings();
      updateSyncStatus();
    });

    function loadSettings() {
      // Load Supabase settings
      const url = supabaseSync.getUrl();
      const key = supabaseSync.getKey();
      const userId = supabaseSync.getStoredUserId();

      if (url) document.getElementById('supabaseUrl').value = url;
      if (key) document.getElementById('supabaseKey').value = key;
      if (userId) document.getElementById('supabaseUserId').value = userId;

      // Load goals
      const settings = data.getSettings();
      document.getElementById('weeklyGoalHours').value = settings.weeklyGoalHours || 14;
      document.getElementById('dailyGoalMinutes').value = settings.dailyGoalMinutes || 30;
    }

    function updateSyncStatus() {
      const statusCard = document.getElementById('syncStatusCard');
      const icon = document.getElementById('syncStatusIcon');
      const label = document.getElementById('syncStatusLabel');
      const message = document.getElementById('syncStatusMessage');

      if (supabaseSync.isConfigured()) {
        statusCard.className = 'sync-status-card configured';
        icon.textContent = '✓';
        label.textContent = 'Configured';
        message.textContent = 'Click "Sync Now" in the header to sync across devices';
        supabaseSync.updateSyncIndicator('success');
      } else {
        statusCard.className = 'sync-status-card not-configured';
        icon.textContent = '○';
        label.textContent = 'Not Configured';
        message.textContent = 'Set up Supabase to sync across devices';
        supabaseSync.updateSyncIndicator('not-configured');
      }
    }

    function toggleKeyVisibility() {
      const input = document.getElementById('supabaseKey');
      const btn = event.target;
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'Hide';
      } else {
        input.type = 'password';
        btn.textContent = 'Show';
      }
    }

    async function saveSyncSettings(event) {
      event.preventDefault();

      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();
      const userId = document.getElementById('supabaseUserId').value.trim();

      if (!url || !key) {
        showToast('Please enter both URL and key', 'error');
        return false;
      }

      if (!userId) {
        showToast('Please enter a User ID', 'error');
        return false;
      }

      supabaseSync.setUrl(url);
      supabaseSync.setKey(key);
      supabaseSync.setStoredUserId(userId);

      updateSyncStatus();

      // Trigger initial sync
      showToast('Connecting...');
      const success = await supabaseSync.pull();
      if (success) {
        showToast('Sync enabled and data synced!');
      } else {
        showToast('Settings saved but sync failed. Check your credentials.', 'error');
      }

      return false;
    }

    async function testConnection() {
      const resultEl = document.getElementById('connectionTestResult');
      resultEl.classList.remove('hidden', 'success', 'error');
      resultEl.textContent = 'Testing connection...';

      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();

      if (!url || !key) {
        resultEl.classList.add('error');
        resultEl.textContent = 'Please enter both URL and key first.';
        return;
      }

      // Temporarily set credentials for test
      const originalUrl = supabaseSync.getUrl();
      const originalKey = supabaseSync.getKey();
      supabaseSync.setUrl(url);
      supabaseSync.setKey(key);

      const result = await supabaseSync.testConnection();

      if (result.success) {
        resultEl.classList.add('success');
        resultEl.textContent = result.message;
      } else {
        resultEl.classList.add('error');
        resultEl.textContent = `Connection failed: ${result.message}`;
        // Restore original settings if test failed
        supabaseSync.setUrl(originalUrl);
        supabaseSync.setKey(originalKey);
      }
    }

    function clearSyncSettings() {
      if (confirm('Disable cloud sync? Your data will remain stored locally.')) {
        supabaseSync.setUrl(null);
        supabaseSync.setKey(null);
        supabaseSync.setStoredUserId(null);
        document.getElementById('supabaseUrl').value = '';
        document.getElementById('supabaseKey').value = '';
        document.getElementById('supabaseUserId').value = '';
        updateSyncStatus();
        showToast('Cloud sync disabled');
      }
    }

    function saveGoals(event) {
      event.preventDefault();

      const settings = {
        weeklyGoalHours: parseInt(document.getElementById('weeklyGoalHours').value) || 14,
        dailyGoalMinutes: parseInt(document.getElementById('dailyGoalMinutes').value) || 30
      };

      data.updateSettings(settings);
      showToast('Goals saved!');
      return false;
    }

    function exportData() {
      const exportData = {
        dailyLogs: data.getDailyLogs(),
        topics: data.getTopics(),
        applications: data.getApplications(),
        settings: data.getSettings(),
        exportDate: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ml-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('Data exported!');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);

          if (confirm('This will replace all your current data. Continue?')) {
            if (importedData.dailyLogs) storage.set(STORAGE_KEYS.DAILY_LOGS, importedData.dailyLogs);
            if (importedData.topics) storage.set(STORAGE_KEYS.TOPICS, importedData.topics);
            if (importedData.applications) storage.set(STORAGE_KEYS.APPLICATIONS, importedData.applications);
            if (importedData.settings) storage.set(STORAGE_KEYS.SETTINGS, importedData.settings);

            showToast('Data imported successfully!');
            loadSettings();
          }
        } catch (error) {
          showToast('Invalid JSON file', 'error');
        }
      };
      reader.readAsText(file);

      // Reset file input
      event.target.value = '';
    }

    function clearAllData() {
      if (confirm('Are you sure you want to delete ALL your data? This cannot be undone.')) {
        if (confirm('This will permanently delete all your practice logs, topics, applications, and settings. Are you REALLY sure?')) {
          storage.clearAll();
          showToast('All data cleared');
          window.location.reload();
        }
      }
    }

    function showToast(message, type = 'success') {
      // Remove existing toast
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
