<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ML Interview Prep Tracker - Settings</title>
  <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-content">
      <h1>ML Interview Prep Tracker</h1>
      <div class="header-right">
        <div id="syncIndicator" class="sync-indicator" onclick="supabaseSync.manualSync()">
          <span class="sync-icon">○</span>
          <span class="sync-text"></span>
        </div>
        <nav>
          <ul>
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="log.html">Daily Log</a></li>
            <li><a href="topics.html">Topics</a></li>
            <li><a href="applications.html">Applications</a></li>
            <li><a href="analytics.html">Analytics</a></li>
            <li><a href="settings.html" class="active">Settings</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <h2 class="page-title">Settings</h2>

    <!-- Cloud Sync -->
    <div class="card">
      <h2>Cloud Sync</h2>
      <div class="sync-status-card" id="syncStatusCard">
        <div class="sync-status-icon" id="syncStatusIcon">○</div>
        <div class="sync-status-details">
          <div class="sync-status-label" id="syncStatusLabel">Not Configured</div>
          <div class="sync-status-message" id="syncStatusMessage">Sync your data across devices</div>
        </div>
      </div>

      <div id="connectionTestResult" class="connection-result hidden" style="margin-top: 16px;"></div>

      <div class="btn-group" style="margin-top: 16px;">
        <button type="button" class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
      </div>
    </div>

    <!-- Goals Settings -->
    <div class="card">
      <h2>Goals</h2>
      <form id="goalsForm" onsubmit="return saveGoals(event)">
        <div class="form-group">
          <label for="weeklyGoalHours">Weekly Goal (hours)</label>
          <input type="number" id="weeklyGoalHours" name="weeklyGoalHours" min="1" max="100" value="14">
        </div>

        <div class="form-group">
          <label for="dailyGoalMinutes">Daily Goal (minutes)</label>
          <input type="number" id="dailyGoalMinutes" name="dailyGoalMinutes" min="5" max="480" value="30">
        </div>

        <button type="submit" class="btn">Save Goals</button>
      </form>
    </div>

    <!-- Data Management -->
    <div class="card">
      <h2>Data Management</h2>

      <div class="data-actions">
        <div class="data-action-item">
          <h3>Export Data</h3>
          <p class="text-muted">Download all your data as a JSON file.</p>
          <button class="btn btn-secondary" onclick="exportData()">Export</button>
        </div>

        <div class="data-action-item">
          <h3>Import Data</h3>
          <p class="text-muted">Import data from a JSON file.</p>
          <input type="file" id="importFile" accept=".json" style="display: none" onchange="importData(event)">
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>ML Interview Prep Tracker v1.0</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./js/app.js"></script>
  <script src="./js/sync.js"></script>
  <script src="./js/auth.js"></script>
  <script>
    // Check authentication (async - syncs first to check device authorization)
    (async () => {
      const isAuthed = await auth.initWithSync();
      if (!isAuthed) return;
    })();

    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
      await data.init();
      loadSettings();
      updateSyncStatus();
    });

    function loadSettings() {
      // Load goals
      const settings = data.getSettings();
      document.getElementById('weeklyGoalHours').value = settings.weeklyGoalHours || 14;
      document.getElementById('dailyGoalMinutes').value = settings.dailyGoalMinutes || 30;
    }

    function updateSyncStatus() {
      const statusCard = document.getElementById('syncStatusCard');
      const icon = document.getElementById('syncStatusIcon');
      const label = document.getElementById('syncStatusLabel');
      const message = document.getElementById('syncStatusMessage');

      if (supabaseSync.isConfigured()) {
        statusCard.className = 'sync-status-card configured';
        icon.textContent = '✓';
        label.textContent = 'Configured';
        message.textContent = 'Click "Sync Now" in the header to sync across devices';
        supabaseSync.updateSyncIndicator('success');
      } else {
        statusCard.className = 'sync-status-card not-configured';
        icon.textContent = '○';
        label.textContent = 'Not Configured';
        message.textContent = 'Set up Supabase to sync across devices';
        supabaseSync.updateSyncIndicator('not-configured');
      }
    }

    async function testConnection() {
      const resultEl = document.getElementById('connectionTestResult');
      resultEl.classList.remove('hidden', 'success', 'error');
      resultEl.textContent = 'Testing connection...';

      if (!supabaseSync.isConfigured()) {
        resultEl.classList.add('error');
        resultEl.textContent = 'Sync is not configured.';
        return;
      }

      const result = await supabaseSync.testConnection();

      if (result.success) {
        resultEl.classList.add('success');
        resultEl.textContent = result.message;
      } else {
        resultEl.classList.add('error');
        resultEl.textContent = `Connection failed: ${result.message}`;
      }
    }

    function saveGoals(event) {
      event.preventDefault();

      const settings = {
        weeklyGoalHours: parseInt(document.getElementById('weeklyGoalHours').value) || 14,
        dailyGoalMinutes: parseInt(document.getElementById('dailyGoalMinutes').value) || 30
      };

      data.updateSettings(settings);
      showToast('Goals saved!');
      return false;
    }

    function exportData() {
      const exportData = {
        dailyLogs: data.getDailyLogs(),
        topics: data.getTopics(),
        applications: data.getApplications(),
        settings: data.getSettings(),
        exportDate: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ml-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('Data exported!');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);

          if (confirm('This will replace all your current data. Continue?')) {
            if (importedData.dailyLogs) storage.set(STORAGE_KEYS.DAILY_LOGS, importedData.dailyLogs);
            if (importedData.topics) storage.set(STORAGE_KEYS.TOPICS, importedData.topics);
            if (importedData.applications) storage.set(STORAGE_KEYS.APPLICATIONS, importedData.applications);
            if (importedData.settings) storage.set(STORAGE_KEYS.SETTINGS, importedData.settings);

            showToast('Data imported successfully!');
            loadSettings();
          }
        } catch (error) {
          showToast('Invalid JSON file', 'error');
        }
      };
      reader.readAsText(file);

      // Reset file input
      event.target.value = '';
    }

    function showToast(message, type = 'success') {
      // Remove existing toast
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
